# ![Logo](https://raw.githubusercontent.com/FrancescoBonizzi/Boolli/master/Boolli-icon-64x64.png) Boolli

[![Build status](https://dev.azure.com/fbonizzi/GithubOpenSource/_apis/build/status/Boolli)](https://dev.azure.com/fbonizzi/GithubOpenSource/_build/latest?definitionId=19)
[![Quality Gate Status](https://sonarcloud.io/api/project_badges/measure?project=FrancescoBonizzi_Boolli&metric=alert_status)](https://sonarcloud.io/dashboard?id=FrancescoBonizzi_Boolli)

Boolli is a boolean expressions interpreter.

What is Boolli able to do? Saying `true` or `false` given a boolean expression!

To Boolli, a boolean expression is something generated by this `EBNF` grammar:

  ```
  expr: factor((and | or) factor)*
  factor: (not)* factor | boolean | LPAR expr RPAR
  boolean: true | false | 0 | 1
  ```

Bolli is composed of:
- A lexer
- A parser
- An interpreter

The base data structure is Abstract Syntax Tree

How can it be helpful?
- To understand how to parse a simple grammar
- When you substitute boolean tokens with `Func<bool>` (even `Func<Task<bool>>`) tokens and define a simple rule system

# Installation
`PM> Install-Package Boolli`

[![NuGet](https://img.shields.io/nuget/v/Boolli.svg)](https://www.nuget.org/packages/Boolli/)

# Getting started
#### 1. Evaluate a simple boolean expression

```csharp
var boolli = new Evaluator();
string booleanExpression = "not true and false or (true and false)";
bool result = boolli.EvaluateBooleanExpression(booleanExpression);
```

You can also use `0` as `false` and `1` as `true`:
```csharp
var boolli = new Evaluator();
string booleanExpression = "not 1 and 0 or (true and false)";
bool result = boolli.EvaluateBooleanExpression(booleanExpression);
```

#### 2. Evaluate a simple `Func<bool>` expression
```csharp
var boolli = new Evaluator();
bool result = boolli.EvaluateFuncOfBoolExpression(
    "f1 and f2",
    new NamedBooleanFunction[]
    {
        new NamedBooleanFunction("f1", () => true),
        new NamedBooleanFunction("f2", () => false),
    });
```

#### 3. Evaluate a simple `Func<Task<bool>>` expression
```csharp
var boolli = new Evaluator();
bool result = await boolli.EvaluateFuncOfBoolExpressionAsync(
    "f3 and f4",
    new NamedAsyncBooleanFunction[]
    {
        new NamedAsyncBooleanFunction("f3", async () => { await Task.Delay(100); return true; }),
        new NamedAsyncBooleanFunction("f4", async () => { await Task.Delay(100); return true; }),
    });
```
#### 4. A real case scenario
```csharp
async Task Main()
{
	var sampleRules = new Rule[]
	{
			new Rule()
			{
				RuleName = "RAM full and CPU busy last minute",
				BooleanExpression = $"{Metrics.CPUPercentage} and {Metrics.UsedRAMGigaBytes}",
				ResultingAlertGravity = AlertGravity.Critical,
				MessageFormat = "Attention! Last minute CPU ({0}%) and RAM ({1} GB) are very critical! (Last value collection time: {2})",
				TimeFrameMinutes = 1,
				DataEvaluationFunctionDescription  = new DataEvaluationFunctionDescription[]
				{
					new DataEvaluationFunctionDescription()
					{
						Metric = Metrics.CPUPercentage,
						Threshold = 90
					},
					new DataEvaluationFunctionDescription()
					{
						Metric = Metrics.UsedRAMGigaBytes,
						Threshold = 7
					}
				}
			},
			new Rule()
			{
				RuleName = "RAM and CPU will be busy soon",
				BooleanExpression = $"{Metrics.CPUPercentage} or {Metrics.UsedRAMGigaBytes}",
				ResultingAlertGravity = AlertGravity.Warning,
				MessageFormat = "Last hour data: it seems that CPU ({0}%) or RAM ({1} GB) are going to become critical (Last value collection time: {2})",
				TimeFrameMinutes = 60,
				DataEvaluationFunctionDescription  = new DataEvaluationFunctionDescription[]
				{
					new DataEvaluationFunctionDescription()
					{
						Metric = Metrics.CPUPercentage,
						Threshold = 60
					},
					new DataEvaluationFunctionDescription()
					{
						Metric = Metrics.UsedRAMGigaBytes,
						Threshold = 4
					}
				}
			}
	};

	// Get data from some monitoring sources
	var monitoringDataRepository = new FakeMonitoringDataRepository();
	var fakeData = monitoringDataRepository.GetLastHourData();

	var alertGenerator = new AlertGenerator(sampleRules);
	var alerts = alertGenerator.GenerateAlerts(fakeData);
	alerts.Dump();
}

public class AlertGenerator
{
	private Rule[] _alertGenerationRules;

	public AlertGenerator(Rule[] alertGenerationRules)
	{
		_alertGenerationRules = alertGenerationRules;
	}

	public List<Alert> GenerateAlerts(MonitoringData[] monitoringData)
	{
		var alerts = new List<Alert>();
		var boolli = new Evaluator();

		foreach (var rule in _alertGenerationRules)
		{
			// I need object for String.Format
			var lastValues = new Dictionary<Metrics, MonitoringData>();

			var namedBooleanFunctions = rule.DataEvaluationFunctionDescription.Select(d => new NamedBooleanFunction(
				d.Metric.ToString(),
				() =>
				{
					(bool IsCritical, MonitoringData data) = ValueCritical(
						monitoringData,
						DateTime.Now.AddMinutes(-rule.TimeFrameMinutes),
						d.Metric,
						d.Threshold);

					if (IsCritical && data != null)
					{
						lastValues[d.Metric] = data;
					}

					return IsCritical;
				})).ToArray();

			bool alertShouldBeGenerated = boolli.EvaluateFuncOfBoolExpression(
				rule.BooleanExpression,
				namedBooleanFunctions);

			if (alertShouldBeGenerated)
			{
				var stringFormatParameters = new List<object>();
				foreach (var lastValue in lastValues)
				{
					stringFormatParameters.Add((int)lastValue.Value.MetricValue);
				}
				stringFormatParameters.Add(lastValues.Values.OrderByDescending(v => v.CollectionTime).FirstOrDefault().CollectionTime);

				alerts.Add(new Alert()
				{
					GeneratingRuleName = rule.RuleName,
					AlertGravity = rule.ResultingAlertGravity,
					GenerationDate = DateTime.Now,
					Message = string.Format(rule.MessageFormat, stringFormatParameters.ToArray())
				});
			}
		}

		return alerts;
	}

	private (bool IsCritical, MonitoringData Data) ValueCritical(
		MonitoringData[] monitoringData,
		DateTime startingDate,
		Metrics metric,
		double threshold)
	{
		foreach (var data in monitoringData
			.Where(d => d.CollectionTime > startingDate)
			.OrderByDescending(d => d.CollectionTime))
		{
			if (data.Metric == metric && data.MetricValue > threshold)
			{
				return (true, data);
			}
		}

		return (false, null);
	}
}

public class DataEvaluationFunctionDescription
{
	public Metrics Metric { get; set; }
	public double Threshold { get; set; }
}

public class Alert
{
	public string Message { get; set; }
	public DateTime GenerationDate { get; set; }
	public AlertGravity AlertGravity { get; set; }
	public string GeneratingRuleName { get; set; }
}

public enum AlertGravity : byte
{
	Information = 1,
	Warning = 2,
	Critical = 3
}

public enum Metrics : byte
{
	CPUPercentage = 1,
	UsedRAMGigaBytes = 2
}

public class Rule
{
	public string RuleName { get; set; }
	public string BooleanExpression { get; set; }
	public AlertGravity ResultingAlertGravity { get; set; }
	public string MessageFormat { get; set; }
	public int TimeFrameMinutes { get; set; }
	public DataEvaluationFunctionDescription[] DataEvaluationFunctionDescription { get; set; }
}

public class MonitoringData
{
	public Metrics Metric { get; set; }
	public double MetricValue { get; set; }
	public DateTime CollectionTime { get; set; }
}

public interface IMonitoringDataRepository
{
	public MonitoringData[] GetLastHourData();
}

public class FakeMonitoringDataRepository : IMonitoringDataRepository
{
	private static Random _random = new Random();

	public MonitoringData[] GetLastHourData()
	{
		var fakeData = new List<MonitoringData>();

		var startingTime = DateTime.Now;

		for (int d = 0; d < 10; ++d)
		{
			fakeData.Add(new MonitoringData()
			{
				Metric = Metrics.CPUPercentage,
				MetricValue = _random.NextDouble() * 100,
				CollectionTime = startingTime.AddMinutes(d)
			});
		}

		for (int d = 0; d < 10; ++d)
		{
			fakeData.Add(new MonitoringData()
			{
				Metric = Metrics.UsedRAMGigaBytes,
				MetricValue = _random.NextDouble() * 8,
				CollectionTime = startingTime.AddMinutes(d)
			});
		}

		return fakeData.ToArray();
	}
}
```

# Building
Simply clone this repository and build the `Boolli.sln` solution.

# How to contribute
- Report any issues
- Propose new features / improvements
- Just telling your opinion :-)
